# issue --output foo.wav でwav保存できるか検討する #29
[issues #29](https://github.com/cat2151/cat-play-mml/issues/29)

## 検討結果

### server側ライブラリに機能追加が必要か？

**不要** ❌

`ym2151-log-player-rust`ライブラリには既に`wav_writer`モジュールが実装されており、WAVファイル生成機能が完備されています。

### 実装状況

**実装完了** ✅

シンプルに当アプリでWAV出力ができるようになりました。

## 実装内容

### 追加された機能（デバッグモード）

- `--output <FILE>` フラグで3種類のWAVファイルを生成（音質デバッグ用）
- MML文字列、MMLファイル、MIDIファイル、YM2151 JSONファイルからWAV生成が可能

### 使用例

```bash
# MML文字列から3つのデバッグWAV生成
cat-play-mml --output foo.wav cde

# 生成されるファイル：
# - foo_realtime.wav (AudioPlayer wav_buffer, 55930 Hz) ※Windows のみ
# - foo_debug48k.wav (リサンプリング後, 48000 Hz)
# - foo_debug55k.wav (ネイティブレート, 55930 Hz)

# MMLファイルから生成
cat-play-mml --output output.wav input.mml
```

### WAVファイル仕様

#### foo_realtime.wav（Windows のみ）
- フォーマット: 16-bit PCM ステレオ
- サンプリングレート: **55930 Hz**（OPMネイティブレート）
- AudioPlayerのwav_bufferから取得（サーバーと同じ動作）
- リサンプリング **なし**
- Linux等では生成スキップ

#### foo_debug48k.wav
- フォーマット: 16-bit PCM ステレオ
- サンプリングレート: **48000 Hz**
- wav_writer + AudioResamplerを使用
- 55930 Hz → 48000 Hz へリサンプリング

#### foo_debug55k.wav
- フォーマット: 16-bit PCM ステレオ
- サンプリングレート: **55930 Hz**（OPMネイティブレート）
- wav_writerを使用
- リサンプリング **なし**

全ファイル共通：
- 余韻の自動検出と生成
- 進捗表示機能付き

### プラットフォーム対応

- **Windows**: リアルタイム再生 + 3種類のWAV出力
- **Linux/その他**: 2種類のWAV出力（debug48k, debug55k）
  - foo_realtime.wav は realtime-audio 機能が必要なためスキップ

### 技術詳細

実装には以下を使用：

1. **foo_realtime.wav** (AudioPlayer):
   - `ym2151_log_player_rust::audio::AudioPlayer` - リアルタイム再生シミュレーション
   - `AudioPlayer::get_wav_buffer()` - wav_bufferから取得（55930 Hz、リサンプリングなし）
   
2. **foo_debug48k.wav** (wav_writer + Resampler):
   - `ym2151_log_player_rust::resampler::AudioResampler` - リサンプリング処理
   - `ym2151_log_player_rust::wav_writer::write_wav()` - WAV書き込み（48000 Hz）

3. **foo_debug55k.wav** (wav_writer):
   - `ym2151_log_player_rust::wav_writer::generate_wav()` - WAV生成（55930 Hz）
   - `ym2151_log_player_rust::player::Player` - 音源エミュレーション
   - `ym2151_log_player_rust::events::EventLog` - イベントログ処理

### 重要な発見

調査の結果、以下が判明しました：
- **AudioPlayerのwav_bufferは55930 Hzで保存される**（48000 Hzではない）
- リサンプリング（55930 Hz → 48000 Hz）は **音声デバイスへの出力のみ** に適用される
- WAVバッファのキャプチャにはリサンプリングは適用されない

この動作は`ym2151-log-player-rust`と`ym2151-log-play-server`の両方で同じです。

既存のライブラリ機能のみで実装可能だったため、アップストリームへの変更は不要でした。

